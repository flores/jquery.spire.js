(function(a){a.spire={options:{url:"http://api.spire.io",version:"1.0",timeout:3e4},isConnecting:!1,headers:{},messages:{queue:[]},requests:{description:{},sessions:{},channels:{},subscriptions:{},messages:{}}},a.spire.headers.authorization=function(a){return["Capability",a.capability].join(" ")},a.spire.headers.mediaType=function(b){return a.spire.schema[a.spire.options.version][b].mediaType},a.spire.messages.subscribe=function(b,c){a.spire.connect(function(d){var e={session:d,name:b};a.spire.requests.channels.create(e,function(b,e){if(b)throw b;var f={channels:[e],events:["messages"],session:d};a.spire.requests.subscriptions.create(f,function(b,d){var e={subscription:d},f=function(){a.spire.requests.subscriptions.get(e,function(a,b){b.messages.length>0&&c(null,b.messages),f()})};f()})})})},a.spire.messages.publish=function(b,c){if(a.spire.isConnecting){a.spire.messages.queue.push({message:b,callback:c});return}a.spire.connect(function(d){var e={session:d,name:b.channel};a.spire.requests.channels.create(e,function(d,e){var f={channel:e,content:b.content};a.spire.requests.messages.create(f,function(a,b){if(a)throw a;c&&c(null,b)})})})},a.spire.connect=function(b){a.spire.isConnecting=!0,a.spire.requests.description.get(function(c,d){if(c)throw c;var e={key:a.spire.options.key},f=function(c,d){if(c)throw c;return a.spire.isConnecting=!1,a.spire.session=d,a.spire.messages.queue.length>0&&a.each(a.spire.messages.queue,function(b){var c=a.spire.messages.queue.pop();c&&a.spire.messages.publish(c.message,c.callback)}),b(d)};a.spire.session?f(null,a.spire.session):a.spire.requests.sessions.create(e,f)})},a.spire.requests.description.get=function(b){if(a.spire.resources){var c={resources:a.spire.resources,schema:a.spire.schema};return b(null,c)}a.ajax({type:"GET",url:a.spire.options.url,dataType:"json",error:function(a,b,c){},success:function(c,d,e){a.spire.resources=c.resources,a.spire.schema=c.schema,b(null,c)}})},a.spire.requests.sessions.create=function(b,c){if(!b.key){var d=["You need a key to do that! Try doing this:","   $.spire.options.key = <your account key>"].join("\n");throw new Error(d)}a.ajax({type:"post",url:a.spire.resources.sessions.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("account"),Accept:a.spire.headers.mediaType("session")},data:JSON.stringify({key:b.key}),dataType:"json",error:function(a){},success:function(a,b,d){c(null,a)}})},a.spire.requests.channels.create=function(b,c){var d=b.session.resources.channels,e=b.name;a.ajax({type:"post",url:d.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("channel"),Accept:a.spire.headers.mediaType("channel"),Authorization:a.spire.headers.authorization(d)},data:JSON.stringify({name:e}),dataType:"json",error:function(a){},success:function(a,b,d){c(null,a)}})},a.spire.requests.subscriptions.create=function(b,c){var d=b.session.resources.subscriptions,e={events:b.events,channels:[]};a.each(b.channels,function(a,b){e.channels.push(b.url)}),a.ajax({type:"post",url:d.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("subscription"),Accept:a.spire.headers.mediaType("subscription"),Authorization:a.spire.headers.authorization(d)},data:JSON.stringify(e),error:function(a){},success:function(a,b,d){c(null,a)}})},a.spire.requests.subscriptions.get=function(b,c){var d=b.subscription;data={timeout:b.timeout||a.spire.options.timeout/1e3},data["last-message"]=d["last-message"],a.ajax({type:"get",url:d.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("events"),Accept:a.spire.headers.mediaType("events"),Authorization:a.spire.headers.authorization(d)},data:data,error:function(a,b,d){console.log("errr",d),d==="timeout"&&c(null,{messages:[]})},success:function(b,e,f){b.messages.length>0&&(d["last-message"]=a(b.messages).last()[0].timestamp),c(null,b)}})},a.spire.requests.messages.create=function(b,c){var d=b.channel,e=b.content;a.ajax({type:"post",url:d.url,beforeSend:function(a){a.withCredentials=!0},headers:{"Content-Type":a.spire.headers.mediaType("message"),Accept:a.spire.headers.mediaType("message"),Authorization:a.spire.headers.authorization(d)},data:JSON.stringify({content:e}),error:function(a){},success:function(a,b,d){c(null,a)}})}})(jQuery)